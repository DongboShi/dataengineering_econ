\mainmatter

# 数据操纵 {#manipulate}

> 整齐数据都是一样的，凌乱数据各有各的凌乱。--- Hadley Wickham

数据操纵的目的是把原始数据转变成

## 整洁数据tidydata

### 分析单位(unit of analysis)

为了理解整洁数据，需要先介绍一个新的概念-分析单位。分析单元是实证研究中至关重要的概念。毫不夸张的说，理解分析单位就是理解和设计实证论文的钥匙。然而遗憾的是，分析单位在国内的教学中并没有得到充分的重视。

分析单位是一个"单位"的概念，类似于*千克，公里*，是针对某种对象的"计量"方式。艾尔·巴比在《社会研究方法》中将分析单位定义为"用来考察和总结同类事物特征，解释其中差异的单位。"该定义的核心关键词是*差异*。在艾尔·巴比的基础上，我们可以给出一个更加直观的定义，即**分析单位是研究设计中用于比较研究对象差异的最小计量单位**。设想这样的一个研究教育回报的研究设计，研究对象为上海市的所有应届毕业生，研究者可以通过普查的方式得到所有人的受教育年限与收入水平，此时的分析单位是**个人**。如果研究问题转化为研究生教育对收入的影响，此时，分析单位就不再是**个人**，而成为*研究生学历*与*研究生以下学历*的两个群体，因为同群体内的个人在教育测度上并不存在差异。从这个角度来看，风笑天在其影响范围很广的教材《社会研究方法》中对分析单位的定义就有点草率了。风笑天将分析单位定义为*"一项社会科学的研究对象"*，这个定义直接将分析单位与研究对象等价。

与分析单位密切相关的一个概念是**观测单位(unit of observation)**，指的是观测数据中的计量单位。直观来说，就是数据每一行的单位。在上面的两个例子里面，数据都是在个人层面采集的，观测单位都是**个人**。这就看出了观测单位与分析单位之间的细微差别。

单位与变量的关系

在操作层面，分析单位是由自变量的设计决定的，而观测单位是由因变量的设计决定的。在介绍理论与模型的章节中，我们提到当前的理论主要是关注两个变量之间的关系。因此，此处的自变量指的是我们关心的核心自变量(variable of interest)。所以才说，分析单位是实证研究的钥匙，当我们开始一项研究的时候，第一个要回答的问题便是这个研究的自变量与因变量分别是在什么"单位"上测量的。同样的道理，当我们去精度别人的论文时，首先要理解的便是他的回归中的分析单位与观测单位。如果我们看到识别模型的为 $$y_{i,j,t} = \alpha + \beta \times x_{j,t} + \epsilon_{i,j,t}$$

我们便可以确定此处的分析单位是{j,t}，而观测单位是{i,j,t}，在回归表中的观测值数量（样本大小N）应该等于$I \times J \times T$。

所以我们常说，看懂回归表格中的观测值数量是判断回归是否看懂的黄金标准。

## 整齐数据

了解完变量与分析单位后，我们就可以介绍整齐数据（tidy data）的定义及其背后深刻的哲学思考了。

### 整齐数据的缘起

正如Hadley所说，数据分析中超过80%的时间都被用于数据清理与变形等为数据分析做准备的工作。在实践中，我们往往要处理大量的不同类型与来源的数据，但是却没有一个理论告诉我们，数据清理的目标与终点是什么。在这篇文章中，Hadley把他创造plyr与ggplot2中总结出来的数据哲学概括为一个重要的思想，即整齐数据。整齐数据是可以支撑数据分析的结构化的数据集，是数据清理的终点，也是数据分析的起点。

### 整齐数据的定义

整齐数据是针对"表"这一类数据结构的定义。实际上，表是我们数据分析时使用到的最主要的数据结构。"表"是一个二维的数据结构，表的基本元素是单元格（cell），具有行（row）与列（volume）两个属性（大多数时候，行列是不可以互换的）。每个单元格中储存一个数据。

回忆一下，我们讨论过的变量与观测单元的概念。变量指的是对研究对象的某一个属性（概念）的测度，而一个观测是属于同一个观测个体的所有变量。当我们提到表格时，一般默认表格的"第零行"为表头，用于储存变量名，而非数据值。

当一个表格满足

1.  每一列都储存同一个变量，且相同变量都储存在同一列
2.  每一行都储存对观测单元的一个观测，且同一个观测都储存于同一行
3.  一个表储存同一个观测单元

三个条件时，该表便是一组整齐数据。违背以上三个条件中的任何一个的表格都不是整齐数据，我们将其称为凌乱数据（Messy data）。

我们看下面的三组数据，分别包含了

当我们使用表1计算xx变量的平均数时，需要通过复杂的数据提取与计算。如果我们使用表2，则可以轻松的通过mean(xx)来达到同样的目的。这一下子就看出了整齐数据蕴含的力量。

实际上，整齐数据直接对应了研究设计中使用的数据结构，因此可以直接用于回归分析。另一方面，R中的可视化工具ggplot2也是基于整齐数据而设计的，整齐数据在可视化中也有着天然的不可替代的优势。

### 数据的凌乱点

Hadley在他的论文中总结了5种最常见的凌乱点：

1.  表头不是变量名，而是数据值
2.  多个变量被储存在同一列
3.  变量同时被储存在行与列中
4.  存在两个及以上的观测单元
5.  同一组观测被存在多行中

当然，我们永远不能低估数据的凌乱程度，在实际数据分析时遇到超出想象的情形也无需大惊小怪。

## 数据操纵案例

先根据数据变形的目的
